---
title: "Statistics-lecture-2024-01-10-confounds-multilevel-statistics"
author: "Adam Tallman"
date: "2024-01-09"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggdag)
library(ggplot2)
library(VGAM)
library(ggExtra)
library(tidyverse)
library(gridExtra)
library(lme4)
library(lmerTest)
```


```{r}
pipe.example <- dagify(Y~Z,
                       Z~X,
                       labels = c(
                         "X" = "Cause",
                         "Y" = "Effect",
                         "Z" = "Confound"
                       )
                       )
ggdag(pipe.example, text=FALSE, use_labels = "label")
```

Let's imagine we have the following situation.

```{r}
pipe.example <- dagify(Y~Z,
                       Z~X,
                       labels = c(
                         "X" = "Wealth of \n parents",
                         "Y" = "Measure of intelligence",
                         "Z" = "School one \n attends"
                       )
                       )
ggdag(pipe.example, text=FALSE, use_labels = "label")
```

We can get something like a wealth distribution by simulating a pareto distribution. We can use the rpareto function in the VGAM package.

```{r}
num_individuals <- 1000
alpha <- 1.5 #how unequal they are going to be
wealth_distribution <- rpareto(num_individuals, shape=alpha)
df <- data.frame(Wealth = wealth_distribution)
ggplot(df, aes(x = Wealth)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Unequal Wealth Distribution Simulation",
       x = "Wealth",
       y = "Frequency") +
  theme_minimal()
```


```{r}
x1 <- 0.7
x2 <- 0.2
yearly_income_of_parents <- wealth_distribution*40000
school_attended_quality <- yearly_income_of_parents*x1 + rnorm(n=1000, m=0, sd=4000)
test_taking_ability <- school_attended_quality*x2 + rnorm(n=1000, m=0, sd=30000)

```

```{r}
test_score <- (test_taking_ability - min(test_taking_ability)) / (max(test_taking_ability) - min(test_taking_ability)) 
test_score <- (test_score * 1600)+400
SAT <- numeric(length(test_score))
# Loop through each element in the original vector
for (i in seq_along(test_score)) {
  # Check if the value is above 1600
  if (test_score[i] > 1600) {
    # If yes, set it to 1600
    SAT[i] <- 1600
  } else {
    # If no, keep the original value
    SAT[i] <- test_score[i]
  }
}
hist(SAT)
```


```{r}

df <- data.frame(wealth = yearly_income_of_parents,
                 school = school_attended_quality,
                 SAT = SAT)

summary(lm(SAT~wealth, data = df))
```
```{r}
summary(lm(SAT~wealth+school, data = df))
```
Okay, do we conclude from this that wealth is not a causal factor in our SAT scores? More appropriately, do we conclude that changing the wealth distribution will have an impact on general SAT scores? We couldn't conclude that, because we blocked the causal chain from wealth to SAT scores.


## Multilevel models

### Conceptual introduction

Here is out linear model


```{r}
e <- rnorm(m=0, sd=4, n=2000)
x <- rnorm(m=10, sd=5, n= 2000)
a <- 10
b <- 5
y <- a + b * x + e
d <- data.frame(x, e)

plot_x <- ggplot(d, aes(x=x))+
  geom_density(linetype="solid", fill="lightblue", color="darkblue")

plot_e <- ggplot(d, aes(x=e))+
  geom_density(linetype="solid",fill="lightblue", color="darkblue")

grid.arrange(plot_x, plot_e, ncol=2)
```

In this model we have two random variables.

### Multilevel model

```{r}
a <- rnorm(m=10, sd=2, n=2000)
b <- rnorm(m=10, sd=2, n= 2000)
plot_a <- ggplot(d, aes(x=a))+
  geom_density(linetype="solid", fill="pink", color="red")

plot_b <- ggplot(d, aes(x=b))+
  geom_density(linetype="solid", fill="pink", color="red")

grid.arrange(plot_a, plot_b, plot_x, plot_e,  ncol=2)
```

## 

```{r}
x <- seq(1, 3, by=0.1 )
a1 <- 10
a2 <- 20
a3 <- 30
b1 <- 10
b2 <- 10
b3 <- 10
y1 <- a1 + x*b1
d1 <- data.frame(y=y1,x)
y2 <- a2 + x*b2
d2 <- data.frame(y=y2,x)
y3 <- a3 + x*b3
d3 <- data.frame(y=y3,x)
d1$group = "1"
d2$group = "2"
d3$group = "3"
d <- rbind(d1,d2,d3) 
plot_01 <- ggplot(d, aes(x=x, y=y, shape=group))+
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE,
              aes(color=group))

x <- seq(1, 3, by=0.1 )
a1 <- 10
a2 <- 10
a3 <- 10
b1 <- 10
b2 <- 20
b3 <- -10
y1 <- a1 + x*b1
d1 <- data.frame(y=y1,x)
y2 <- a2 + x*b2
d2 <- data.frame(y=y2,x)
y3 <- a3 + x*b3
d3 <- data.frame(y=y3,x)
d1$group = "1"
d2$group = "2"
d3$group = "3"
d <- rbind(d1,d2,d3) 
plot_02 <- ggplot(d, aes(x=x, y=y, shape=group))+
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE,
              aes(color=group))

x <- seq(1, 3, by=0.1 )
a1 <- 10
a2 <- 10
a3 <- 30
b1 <- 10
b2 <- 20
b3 <- -10
y1 <- a1 + x*b1
d1 <- data.frame(y=y1,x)
y2 <- a2 + x*b2
d2 <- data.frame(y=y2,x)
y3 <- a3 + x*b3
d3 <- data.frame(y=y3,x)
d1$group = "1"
d2$group = "2"
d3$group = "3"
d <- rbind(d1,d2,d3) 
plot_03 <- ggplot(d, aes(x=x, y=y, shape=group))+
  geom_smooth(method=lm, se=FALSE, fullrange=TRUE,
              aes(color=group))

grid.arrange(plot_01, plot_02, plot_03, nrow=3)
```


## Simulated example



```{r}
set.seed(200)

## School 1
N1 <- round(runif(1,10,120))
N <- N1            
grades <- runif(N,0,10)
training <- rbinom(N,1,(0.2+grades/20))
gender <- rbinom(N,1,0.5)
b1 <- rnorm(1,2,0.5)
b2 <- rnorm(1,2,0.5)
b3 <- rnorm(1,0,2)
a <- rnorm(1,5,2)
aptitude <- a + b1*grades + b2*training +b3*gender+rnorm(N, sd=1)
school1 <- data.frame(Grades =grades,
                     Training = training, 
                     Aptitude = aptitude,
                     Gender = factor(gender, levels=c(0,1),
                                     labels = c("M", "F")))
```


```{r}
# School 2
N2 <- round(runif(1,10,120)) 
N <- N2
grades <- runif(N, 0, 10)
training <- rbinom(N, 1, (0.2+grades/20))
gender <- rbinom(N, 1, 0.5)
b1 <- rnorm(1,2,0.5)
b2 <- rnorm(1,2,0.5)
b3 <- rnorm(1,0,2)
a <- rnorm(1,5,2)
aptitude <- a + b1*grades + b2*training + b3*gender + rnorm(N, sd= 1) 
school2 <- data.frame(Grades = grades,
                      Training = training,
                      Aptitude = aptitude,
                      Gender = factor(gender, levels=c(0, 1),
                                      labels=c("M", "F")))

N3 <- round(runif(1,10,120))
N <- N3
grades <- runif(N, 0, 10)
training <- rbinom(N, 1, (0.2+grades/20))
gender <- rbinom(N, 1, 0.5)
b1 <- rnorm(1,2,0.5)
b2 <- rnorm(1,2,0.5)
b3 <- rnorm(1,0,2)
a <- rnorm(1,5,2)
aptitude <- a + b1*grades + b2*training + b3*gender + rnorm(N, sd= 1) 
school3 <- data.frame(Grades = grades,
                      Training = training,
                      Aptitude = aptitude,
                      Gender = factor(gender, levels=c(0, 1),
                                      labels=c("M", "F")))


N4 <- round(runif(1,10,120))
N <- N4
grades <- runif(N, 0, 10)
training <- rbinom(N, 1, (0.2+grades/20))
gender <- rbinom(N, 1, 0.5)
b1 <- rnorm(1,2,0.5)
b2 <- rnorm(1,2,0.5)
b3 <- rnorm(1,0,2)
a <- rnorm(1,5,2)
aptitude <- a + b1*grades + b2*training + b3*gender + rnorm(N, sd= 1) 
school4 <- data.frame(Grades = grades,
                      Training = training,
                      Aptitude = aptitude,
                      Gender = factor(gender, levels=c(0, 1),
                                      labels=c("M", "F")))



N5 <- round(runif(1,10,120))
N <- N5
grades <- runif(N, 0, 10)
training <- rbinom(N, 1, (0.2+grades/20))
gender <- rbinom(N, 1, 0.5)
b1 <- rnorm(1,2,0.5)
b2 <- rnorm(1,2,0.5)
b3 <- rnorm(1,0,2)
a <- rnorm(1,5,2)
aptitude <- a + b1*grades + b2*training + b3*gender + rnorm(N, sd= 1) 
school5 <- data.frame(Grades = grades,
                      Training = training,
                      Aptitude = aptitude,
                      Gender = factor(gender, levels=c(0, 1),
                                      labels=c("M", "F")))


N6 <- round(runif(1,10,120))
N <- N6
grades <- runif(N, 0, 10)
training <- rbinom(N, 1, (0.2+grades/20))
gender <- rbinom(N, 1, 0.5)
b1 <- rnorm(1,2,0.5)
b2 <- rnorm(1,2,0.5)
b3 <- rnorm(1,0,2)
a <- rnorm(1,5,2)
aptitude <- a + b1*grades + b2*training + b3*gender + rnorm(N, sd= 1) 
school6 <- data.frame(Grades = grades,
                      Training = training,
                      Aptitude = aptitude,
                      Gender = factor(gender, levels=c(0, 1),
                                      labels=c("M", "F")))

N7 <- round(runif(1,10,120))
N <- N7
grades <- runif(N, 0, 10)
training <- rbinom(N, 1, (0.2+grades/20))
gender <- rbinom(N, 1, 0.5)
b1 <- rnorm(1,2,0.5)
b2 <- rnorm(1,2,0.5)
b3 <- rnorm(1,0,2)
a <- rnorm(1,5,2)
aptitude <- a + b1*grades + b2*training + b3*gender + rnorm(N, sd= 1) 
school7 <- data.frame(Grades = grades,
                      Training = training,
                      Aptitude = aptitude,
                      Gender = factor(gender, levels=c(0, 1),
                                      labels=c("M", "F")))

N8 <- round(runif(1,10,120))
N <- N8
grades <- runif(N, 0, 10)
training <- rbinom(N, 1, (0.2+grades/20))
gender <- rbinom(N, 1, 0.5)
b1 <- rnorm(1,2,0.5)
b2 <- rnorm(1,2,0.5)
b3 <- rnorm(1,0,2)
a <- rnorm(1,5,2)
aptitude <- a + b1*grades + b2*training + b3*gender + rnorm(N, sd= 1) 
school8 <- data.frame(Grades = grades,
                      Training = training,
                      Aptitude = aptitude,
                      Gender = factor(gender, levels=c(0, 1),
                                      labels=c("M", "F")))

N9 <- 300
N <- N9
grades <- runif(N, 0, 10)
training <- rbinom(N, 1, (0.2+grades/20))
gender <- rbinom(N, 1, 0.5)
b1 <- rnorm(1,2,0.5)
b2 <- -1.5
b3 <- rnorm(1,0,2)
a <- rnorm(1,5,2)
aptitude <- a + b1*grades + b2*training + b3*gender + rnorm(N, sd= 1) 
school9 <- data.frame(Grades = grades,
                      Training = training,
                      Aptitude = aptitude,
                      Gender = factor(gender, levels=c(0, 1),
                                      labels=c("M", "F")))

data <- rbind(school1,school2,school3,school4,school5,school6,school7,school8,school9)
```


```{r}
data <- rbind(school1,school2,school3,school4,school5,school6,school7,school8,school9)

data$School <- c(rep(1, N1), rep(2, N2), rep(3, N3), rep(4, N4), rep(5, N5), rep(6, N6), rep(7, N7), rep(8, N8), rep(9, N9))
```

```{r}
##Plotting
library(ggplot2)


```
```{r}
plot.grades.apt <-ggplot(data = data, aes(x = Grades, y = Aptitude, group=School))+   
  facet_wrap( ~ School, ncol=3)+    
  geom_point(aes(colour = School))+ 
  geom_smooth(method = "lm", se = TRUE, aes(colour = School))+  
  xlab("Grades")+ylab("Aptitude")+    
  theme(legend.position = "none") 
plot.grades.apt
```

```{r}
plot.gender.apt <- ggplot(data, aes(x=Gender, y=Aptitude, group=Gender)) + 
  facet_wrap( ~ School, ncol=3)+
  geom_boxplot(aes(fill=Gender))

plot.gender.apt
```

```{r}
mod.9 <- lm(Aptitude~Gender, data=school9)
summary(mod.9)
```

```{r}
## all pooled
M1.pooling <- lm(Aptitude~Training+Grades+Gender, data=data)
summary(M1.pooling)
M1.nopooling <- lm(Aptitude~Training*as.factor(School)+Grades+Gender, data=data)
summary(M1.nopooling)
```


```{r}
M0 <- lmer(Aptitude~1 +(1|School)+Grades, data=data)

M1 <- lmer(Aptitude~Training + (1|School)+Grades, data=data ) 
M2 <- lmer(Aptitude ~Training + (1+Training|School)+Grades, data=data)

summary(M2)
anova(M1,M2,M0)

M0 <- lmer(Aptitude~1+(1|School), data=data)
M1.nopooling <- lm(Aptitude~Gender*Training+as.factor(School), data=data)
summary(M1.nopooling)

M1 <- lmer(Aptitude~Gender+(1+Gender|School), data=data)
summary(M1)
```


